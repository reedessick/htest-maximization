#!/bin/bash

### a simple script to generate random realizations from the Poisson model and processes them with the H-test selection algorithm
### Reed Essick (reed.essick@gmail.com)

#-------------------------------------------------

### generate many realizations from the same process

basedir="output"

#for seed in $(seq 1 1000)
for seed in $(seq 101 1000)
do
    tag="seed-$seed"
    outdir="${basedir}/${tag}"

    echo "-------------------------"
    echo "    processing: $tag"
    echo "-------------------------"

    ### predict file names
    all="${outdir}/make-data_${tag}.hdf5"
    subset="${outdir}/downselect-data_${tag}.hdf5"

    ### generate synthetic data realizations
#    echo \
    ./make-data \
        --output-dir $outdir \
        --tag $tag \
        --seed $seed \
        --num-trials 1000 \
        --noise-mean-differential-rate 50.0 \
        --signal-mean-differential-rate 1.0 \
        --periodic-signal-component 1 0.3 0.0 \
        --periodic-signal-component 2 0.5 0.0 \
        --periodic-signal-component 4 0.2 0.75 \
        --Verbose \
        --histogram

    ### make basic plots summarizing the detection statistics and downselecting data
#    echo \
    ./downselect-data \
        $all \
        --output-dir $outdir \
        --tag $tag \
        --Verbose \
        --trajectory 

    ### actually fit the data and determine whether there are biases

    # fit all data
#    echo \
    ./fit-data \
        $all \
        --harmonic 1 --harmonic 2 --harmonic 4 \
        --output-dir $outdir \
        --tag $tag-all \
        --Verbose \
        --histogram

    # fit the selected subset of data
#    echo \
    ./fit-data \
        $subset \
        --harmonic 1 --harmonic 2 --harmonic 4 \
        --output-dir $outdir \
        --tag $tag-subset \
        --Verbose \
        --histogram

done

#-------------------------------------------------

echo "-------------------------"
echo "summarizing experiments"

#echo \
./compare-realizations \
    --all-data-hdf5 ${basedir}/*/fit-data*all.hdf5 \
    --subset-data-hdf5 ${basedir}/*/fit-data_*subset.hdf5 \
    --output-dir $basedir \
    --Verbose
